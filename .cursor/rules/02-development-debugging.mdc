---
description: 
globs: 
alwaysApply: true
---
# Portfolio Analytics - Development & Debugging Guide

## 🔧 Development Patterns & Best Practices

### Critical Data Type Handling
Always convert Decimal to float for pandas operations:
```python
# ✅ Correct
df['value'] = df['quantity'].astype(float) * df['price'].astype(float)
total_values = portfolio_ts['total'].astype(float)

# ❌ Avoid - causes pandas errors
df['value'] = df['quantity'] * df['price']  # If columns contain Decimal objects
```

### Error Handling Pattern
```python
try:
    # Main processing logic
    result = process_data(df)
    validation_results = validate_data(result)
    
    if validation_results['errors'] > 0:
        logger.warning(f"Found {validation_results['errors']} validation errors")
    
    return result
    
except Exception as e:
    logger.error(f"Processing failed: {e}")
    return pd.DataFrame()  # Graceful degradation
```

### Price Data Priority System
```python
def fetch_prices(asset: str) -> Optional[pd.DataFrame]:
    # 1. Try historical CSV files first
    csv_data = load_historical_price_csv(asset, start_date, end_date)
    if csv_data is not None:
        return csv_data
    
    # 2. Fall back to external APIs
    if asset in CRYPTO_ASSET_IDS:
        return fetch_crypto_prices(asset, start_date, end_date)
    else:
        return fetch_stock_prices(asset, start_date, end_date)
```

### Asset Consolidation Pattern
```python
def consolidate_similar_assets(transactions: pd.DataFrame) -> pd.DataFrame:
    """Consolidate assets that represent the same underlying value."""
    transactions = transactions.copy()
    
    # ETH2 is staked ETH, same price and value
    transactions.loc[transactions['asset'] == 'ETH2', 'asset'] = 'ETH'
    
    return transactions
```

## 🔍 Common Issues & Solutions

### Data Quality Issues

#### 1. Duplicate Transactions
**Check**: Duplicates in [output/transactions_normalized.csv](mdc:output/transactions_normalized.csv)
```python
duplicates = df.duplicated(subset=['timestamp', 'asset', 'quantity', 'price', 'institution']).sum()
```

#### 2. Missing Amount Column
**Problem**: Dashboard expects `amount` column but CSV has `quantity`
**Solution**:
```python
if 'amount' not in df.columns and 'quantity' in df.columns:
    df['amount'] = df['quantity']
```

#### 3. Unknown Transaction Types
**Check**: Unmapped transaction types
```python
unknown_types = (df['type'] == 'unknown').sum()
```

### Price Data Issues

#### yfinance MultiIndex Error
**Problem**: "If using all scalar values, you must pass an index"
**Solution**: Properly handle MultiIndex columns in [app/analytics/portfolio.py](mdc:app/analytics/portfolio.py)
```python
# Correct way to access MultiIndex columns
if isinstance(data.columns, pd.MultiIndex):
    prices = data[('Close', ticker)]  # Use tuple notation
```

#### ETH/ETH2 Consolidation
**Problem**: ETH and ETH2 showing as separate assets
**Solution**: ETH2 is staked ETH and should be consolidated with ETH
- Map ETH2 to ETH for price lookups
- Use `consolidate_eth_holdings()` function in portfolio calculation

#### Options Contracts
**Problem**: Options contracts failing price lookup
**Solution**: Filter out early using pattern detection
```python
if ' ' in asset or 'C00' in asset or 'P00' in asset:
    print(f"⚠️ Skipping options contract: {asset}")
    return None
```

### Portfolio Calculation Issues

#### Transfer Transaction Filtering
**Critical**: Only include portfolio-affecting transaction types:
```python
portfolio_affecting_types = [
    'buy', 'sell', 'staking_reward', 'dividend', 'interest', 
    'deposit', 'withdrawal', 'swap'
]
```
**Exclude**: `transfer_in`, `transfer_out` (internal transfers)

## 🧪 Testing & Validation Commands

### Quick Data Quality Check
```bash
python -c "import pandas as pd; df = pd.read_csv('output/transactions_normalized.csv', parse_dates=['timestamp']); print(f'Loaded {len(df)} transactions'); print(f'Unknown types: {(df[\"type\"] == \"unknown\").sum()}'); print(f'Duplicates: {df.duplicated().sum()}')"
```

### Portfolio Testing
```bash
# Test portfolio calculation
python scripts/testing/test_portfolio_cleaned.py

# Debug specific issues
python scripts/debug/debug_portfolio_issues.py

# Run normalization tests
python -m pytest tests/test_normalization_comprehensive.py -v
```

### Data Analysis Scripts
```bash
# Analyze portfolio assets
python scripts/analysis/analyze_portfolio_assets.py

# Analyze ETH balance issues
python scripts/analysis/analyze_eth_balance.py

# Analyze filtered ETH data
python scripts/analysis/analyze_filtered_eth.py

# General data analysis
python scripts/analysis/analyze_data.py
```

### Debug Scripts
```bash
# Debug portfolio calculation issues
python scripts/debug/debug_portfolio_issues.py

# Debug holdings calculation
python scripts/debug/debug_holdings_calculation.py

# Debug price data loading
python scripts/debug/debug_price_data.py
```

### Data Validation Commands
```bash
# Check transaction count by institution
python -c "import pandas as pd; df = pd.read_csv('output/transactions_normalized.csv'); print(df['institution'].value_counts())"

# Check for unknown transaction types
python -c "import pandas as pd; df = pd.read_csv('output/transactions_normalized.csv'); unknown = df[df['type'] == 'unknown']; print(f'Unknown types: {len(unknown)}')"

# Validate date range
python -c "import pandas as pd; df = pd.read_csv('output/transactions_normalized.csv'); df['timestamp'] = pd.to_datetime(df['timestamp']); print(f'Date range: {df[\"timestamp\"].min()} to {df[\"timestamp\"].max()}')"
```

### Performance Benchmarking
```bash
# Data loading benchmark
python scripts/simple_benchmark.py

# Memory usage check
python -c "import psutil; print(f'Memory: {psutil.virtual_memory().percent}%')"

# Time portfolio calculation
time python scripts/testing/test_portfolio_cleaned.py
```

## 🚨 Troubleshooting Guide

### Common Issues & Quick Fixes

#### "Missing amount column" Error
```python
# Add to data loading
if 'amount' not in df.columns and 'quantity' in df.columns:
    df['amount'] = df['quantity']
```

#### yfinance "scalar values" Error
```python
# Use tuple notation for MultiIndex
if isinstance(data.columns, pd.MultiIndex):
    prices = data[('Close', ticker)]
```

#### High Unknown Transaction Types
1. Check [config/schema_mapping.yaml](mdc:config/schema_mapping.yaml) for missing mappings
2. Add new transaction types to `INSTITUTION_MAPPINGS`
3. Test with `python scripts/test_normalization.py`

#### Portfolio Value Too High/Low
1. Check transaction filtering in `compute_portfolio_time_series_with_external_prices()`
2. Verify price data loading
3. Check for duplicate assets (ETH/ETH2)
4. Validate cumulative holdings calculation

### Red Flags to Watch For
1. Portfolio value >$10M (likely calculation error)
2. Duplicate asset entries in top holdings
3. yfinance "scalar values" errors
4. High percentage of unknown transaction types (>5%)
5. Missing price data for major assets (BTC, ETH, major stocks)

## 🔄 Common Development Workflows

### 1. Adding New Institution Support
1. Add CSV file to [data/transaction_history/](mdc:data/transaction_history)
2. Update [config/schema_mapping.yaml](mdc:config/schema_mapping.yaml)
3. Add institution detection logic in [app/ingestion/loader.py](mdc:app/ingestion/loader.py)
4. Add transaction type mappings in [app/ingestion/normalization.py](mdc:app/ingestion/normalization.py)
5. Test with `python scripts/test_normalization.py`

### 2. Adding New Asset Support
1. Add historical price CSV to [data/historical_price_data/](mdc:data/historical_price_data)
2. Update `CRYPTO_ASSET_IDS` mapping in [app/analytics/portfolio.py](mdc:app/analytics/portfolio.py)
3. Test price loading with debug script
4. Validate portfolio calculation

### 3. Dashboard Development
1. Use [ui/streamlit_app_v2.py](mdc:ui/streamlit_app_v2.py) as base
2. Add components to [ui/components/](mdc:ui/components)
3. Implement caching with `@st.cache_data(ttl=300)`
4. Test performance with real data

## 📊 Expected Results & Quality Targets

### Healthy Portfolio Metrics
- **Portfolio Value**: ~$977K (as of latest fix)
- **Top Assets**: BTC (~$431K), VOO (~$186K), ETH (~$177K)
- **Price Data Coverage**: 64 assets (33 crypto + 31 stocks)
- **Transaction Processing**: ~4,081/4,235 transactions (excluding transfers)

### Data Quality Targets
- **Unknown Transaction Types**: <2%
- **Duplicate Transactions**: 0
- **Missing Data**: 0 for required columns
- **Test Pass Rate**: >93% (85/91 tests)

### Performance Targets
- **Normalization**: <200ms for 10,000+ transactions
- **Portfolio Calculation**: <2 seconds for full analysis
- **Dashboard Load**: <500ms initial load
- **Memory Usage**: <5MB overhead

## 🔧 Key Files for Debugging

### Core Files
- [app/analytics/portfolio.py](mdc:app/analytics/portfolio.py) - Main portfolio calculation logic
- [app/ingestion/normalization.py](mdc:app/ingestion/normalization.py) - Transaction normalization
- [config/schema_mapping.yaml](mdc:config/schema_mapping.yaml) - Institution mappings

### Debug Scripts (scripts/debug/)
- [scripts/debug/debug_portfolio_issues.py](mdc:scripts/debug/debug_portfolio_issues.py) - Comprehensive debugging script
- [scripts/debug/debug_holdings_calculation.py](mdc:scripts/debug/debug_holdings_calculation.py) - Holdings calculation debugging
- [scripts/debug/debug_price_data.py](mdc:scripts/debug/debug_price_data.py) - Price data debugging

### Analysis Scripts (scripts/analysis/)
- [scripts/analysis/analyze_portfolio_assets.py](mdc:scripts/analysis/analyze_portfolio_assets.py) - Portfolio asset analysis
- [scripts/analysis/analyze_eth_balance.py](mdc:scripts/analysis/analyze_eth_balance.py) - ETH balance analysis
- [scripts/analysis/analyze_filtered_eth.py](mdc:scripts/analysis/analyze_filtered_eth.py) - Filtered ETH data analysis
- [scripts/analysis/analyze_data.py](mdc:scripts/analysis/analyze_data.py) - General data analysis

### Test Scripts (scripts/testing/)
- [scripts/testing/test_portfolio_cleaned.py](mdc:scripts/testing/test_portfolio_cleaned.py) - Portfolio testing script
- [tests/test_normalization_comprehensive.py](mdc:tests/test_normalization_comprehensive.py) - 32 normalization tests

### Output Files
- [output/transactions_normalized.csv](mdc:output/transactions_normalized.csv) - Normalized transaction data
- [output/portfolio_timeseries.csv](mdc:output/portfolio_timeseries.csv) - Portfolio value over time

## 🔧 Configuration Management

### Environment Variables
```bash
# Set Python path for imports
export PYTHONPATH=$(pwd)

# Database configuration
export DATABASE_URL="sqlite:///portfolio.db"

# API configuration
export API_PORT=8000
export DASHBOARD_PORT=8502
```

### Pre-commit Checklist
- [ ] All tests pass (`python -m pytest tests/ -v`)
- [ ] Portfolio calculation works (`python scripts/testing/test_portfolio_cleaned.py`)
- [ ] No data quality issues (`python scripts/debug/debug_portfolio_issues.py`)
- [ ] Type hints added for new functions
- [ ] Error handling implemented
- [ ] Documentation updated
